resources:
  accelerators: L4:1
  #memory: 4+
  
num_nodes: 2
file_mounts:
  /training:
    name: ray-train
    #source: ~/data  # Optional: path to local data to upload to the bucket
    store: gcs  # Optional: either of s3, gcs, r2, ibm
    mode: MOUNT  # Optional: either MOUNT or COPY. Defaults to MOUNT.
  /results:
    name: ray-train
    #source: ~/skypilot-logs  # Optional: path to local data to upload to the bucket
    store: gcs  # Optional: either of s3, gcs, r2, ibm
    mode: MOUNT  # Optional: either MOUNT or COPY. Defaults to MOUNT.
workdir: /training

setup: |
  conda activate ray
  if [ $? -ne 0 ]; then
    conda create -n ray python=3.10 -y
    conda activate ray
  fi

  pip install "ray[train]"
  pip install tqdm
  pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
  git clone https://github.com/llm-on-gke/skypilot.git
run: |
  sudo chmod 777 -R /var/tmp
  conda activate ray
  head_ip=`echo "$SKYPILOT_NODE_IPS" | head -n1`
  num_nodes=`echo "$SKYPILOT_NODE_IPS" | wc -l`
  if [ "$SKYPILOT_NODE_RANK" == "0" ]; then
    ps aux | grep ray | grep 6379 &> /dev/null || ray start --head  --disable-usage-stats --port 6379
    sleep 5
    python skypilot/ray-train/train.py --num-workers $num_nodes
  else
    sleep 5
    ps aux | grep ray | grep 6379 &> /dev/null || ray start --address $head_ip:6379 --disable-usage-stats
  fi